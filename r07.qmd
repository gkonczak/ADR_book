# Kombinacje wykres贸w. Pakiet **patchwork**

::: {.callout-note icon="false" appearance="simple"}
**patchwork** to pakiet w jzyku **R**, kt贸ry wspomaga czenie wielu wykres贸w w jedn sp贸jn wizualizacj. Jest szczeg贸lnie przydatny w przypadku wykres贸w tworzonych za pomoc pakietu **ggplot2**. Pakiet umo偶liwia u偶ytkownikowi szybkie organizowanie i ukadanie r贸偶nych wizualizacji w jednym obszarze wykresu. Pozwala tak偶e na doczanie tekst贸w i tabel z danymi w obszarach okna wykresu.
:::

Pakiet **patchwork** do czenia wykres贸w w jedn wizualizacj wykorzystuje operatory matematyczne +, / , \| oraz nawiasy '(' i ')'. Dziaa bezporednio na obiektach (wykresach) wykonanych w **ggplot2**, ale mo偶na tak偶e wykorzysta wykresy oraz tabele pochodzce spoza tego systemu.

Znak '+' pomidzy obiektami (wykresami) **p1** i **p2** oznacza, 偶e wykresy bd umieszczone obok siebie. Jeli jednak tych wykres贸w bdzie wicej, to system bdzie rozmieszcza je w kolejnych wierszach. W przypadku zapisu **p1+p2+p3+p4** Wykresy **p1** i **p2** zostan umieszczone obok siebie w pierwszym wierszu, a wykresy **p3** i **p4** pod nimi, w wierszu drugim. Dla wymuszenia ukadu wykres贸w w jednym wierszu zamiast znaku '+' nale偶y zastosowa znak '\|'. W przypadku zapisu **p1\|p2\|p3\|p4** wszystkie wykresy zostan umieszone w jednym wierszu. Dla umieszczenia dw贸ch wykres贸w **p1** i **p2** w ukadzie pionowym (**p1** ponad **p2**) nale偶y u偶y symbolu '/' i zapisu: **p1/p2**. Do tworzenia kombinacji wykres贸w mog by te偶 wykorzysystywane znaki "(" i ")". Przy zapisie **p1/(p2+p3)/(p4+p5+p6)** wykresy zostan umieszczone w trzech wierszach. W wierszu pierwszym bdzie wykres **p1**, w wierszu rodkowym dwa wykresy **p2** i **p3**, a na samym dole trzy wykresy **p4**, **p5** i **p6**.

Je偶eli pakiety **ggplot2** i **patchwork** zostay wczeniej zainstalowane, to zaadowanie ich oraz pozostaych pakiet贸w wykorzystywanych w tym rozdziale realizowane jest nastpujco:

```{r}
#| warning: false
#| echo: false
#| eval: true
library(ggplot2)
library(patchwork)
library(grid)
library(gridExtra)
library(gridGraphics)
library(ggthemes)
```

Dla konstrukcji wykres贸w w tej czci wykorzystano dostpny w **R** zbi贸r **iris**.

 [Opis zbioru `iris`](https://www.rdocumentation.org/packages/datasets/versions/3.6.2/topics/iris)

::: callout-important
## **iris**

Zbi贸r danych **iris** (znany tak偶e jako Iris Fishera) jest jednym z najbardziej klasycznych i najczciej wykorzystywanych zbior贸w danych w statystyce, uczeniu maszynowym i eksploracji danych. Zosta zebrany przez Edgara Andersona, a spopularyzowany przez Ronalda Fishera w 1936 roku. Zbi贸r ten jest dostpny bezporednio w rodowisku **R**.

Liczba obserwacji: 150

Liczba zmiennych: 5

-   *Sepal.Length* - dugo dziaki kielicha (w centymetrach)
-   *Sepal.Width* - szeroko dziaki kielicha (w centymetrach)
-   *Petal.Length* - dugo patka korony (w centymetrach)
-   *Petal.Width* - szeroko patka korony (w centymetrach)
-   *Species* - gatunek irysa - zmienna czynnikowa (factor) z trzema poziomami odpowiadajcymi nazwom gatunk贸w (setosa, versicolor, virginica)
:::

Zbi贸r **iris** liczy 150 obserwacji, a pierwsze 5 Przedstawiono poni偶ej:

```{r}
#| warning: false
#| echo: false
#| eval: true
head(iris,5)
```

Podstawowe informacje o zmiennych ze zbioru **iris**.

```{r}
#| warning: false
#| echo: false
#| eval: true
summary(iris)
```

## Konstrukcja kompozycji wykres贸w

Przygotowane w programie **R** wykresy nie musz by bezporednio wywietlane, a mog by zapamitane jako obiekty. W pierwszej kolejnoci okrelone zostan trzy obiekty graficzne **p1**, **p2** i **p3**. Poni偶ej przedstawiony jest kod zachowujcy podstawowy wykres w obiekcie o nazwie **p1** i nastpnie wywietlajcy go (por. @fig-iris1). Jest to wykres rozrzutu dla dugoci i szerokoci patk贸w.

```{r}
#| warning: false
#| echo: true
#| eval: true
#| label: fig-iris1
#| fig-cap: Dugo i szeroko patka wedug gatunku

p1 <- ggplot(iris, aes(Petal.Length, Petal.Width, color = Species)) + 
  geom_point(size = 3) + 
  labs(color="Gatunek",
       x = "Dugo patka", 
       y = "Szeroko patka") +
  theme_minimal()
p1
```

W kolejnym kroku konstruowane sa obiekty **p2** i **p3**. Histogram dugoci patk贸w jest zachowany jako **p2** (@fig-iris2), a histogram szerokoci patk贸w jest zachowany jako **p3** (@fig-iris3).

```{r}
#| warning: false
#| echo: false
#| eval: true
#| label: fig-iris2
#| fig-cap: Dugo patka wedug gatunku

p2 <- ggplot(iris, aes(Petal.Length, fill = Species)) + 
  geom_histogram(binwidth = 0.2, alpha = 0.7, color='black') + 
  labs(x = "Dugo patka", 
       y = "Liczba obserwacji") +
  theme_minimal()
p2
```

```{r}
#| warning: false
#| echo: false
#| eval: true
#| label: fig-iris3
#| fig-cap: Szeroko patka wedug gatunku
p3 <- ggplot(iris, aes(Petal.Width, fill = Species)) + 
  geom_histogram(binwidth = 0.1, alpha = 0.7, color='black') + 
  labs( x = "Szeroko patka", 
       y = "Liczba obserwacji") +
  theme_minimal()
p3
```

Dla wywietlenia dw贸ch wykres贸w **p2** i **p3** obok siebie nalezy wykona poni偶sz komend, a efekt jest widoczny na @fig-iris4. W poleceniu dodatkowo wykorzystano funkcj `plot_layout`, dzieki kt贸rej zamieszczono tylko jedn legend cznie dla obu wykres贸w.

```{r}
#| warning: false
#| echo: true
#| eval: true
#| label: fig-iris4
#| fig-cap: Kompozycja wykres贸w. Dugo (po lewej) i szeroko (po prawej) patka wedug gatunku
(p2 + p3) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom")

```

Kolejne konstruowane obiekty **p4** - **p9** s okrelone pni偶ej, ale nie s bezporednio wywietlane.

Jako obiekt **p4** wprowadzony jest wykres wiolinowy dugoci patk贸w, a jako obiekt **p5** wykres wiolinowy dla szerokoci patk贸w.

```{r}
#| warning: false
#| echo: true
#| eval: true
p4 <- ggplot(iris, aes(Species, Petal.Length, fill = Species)) + 
  geom_violin(trim = FALSE, alpha = 0.7) + 
  labs(x = "Gatunek", 
       y = "Dugo patka",
       fill='Gatunek') +
  theme_minimal()
p5 <- ggplot(iris, aes(Species, Petal.Width, fill = Species)) + 
  geom_violin(trim = FALSE, alpha = 0.7) + 
  labs(x = "Gatunek", 
       y = "Szeroko patka",
       fill='Gatunek') +
  theme_minimal()
```

Kolejne dwa wykresy **p6** i **p7** to gstoci odpowiednio dla dugoci i szerokoci patk贸w.

```{r}
p6 <- ggplot(iris, aes(Petal.Length, fill = Species)) + 
  geom_density(alpha = 0.6) + 
  labs(x = "Gatunek", 
       y = "Dugo patka",
       fill='Gatunek') +
  theme_minimal()
p7 <- ggplot(iris, aes(Petal.Width, fill = Species)) + 
  geom_density(alpha=0.6) + 
  labs(x = "Gatunek", 
       y = "Szeroko patka",
       fill='Gatunek') +
  theme_minimal()
```

Ostatnie dwa wykresy wykorzystywane w tym rozdziale to **p8** i **p9** wykresy pudekowe dla odpowiednio dugosci i szerokoci patk贸w.

```{r}

p8 <- ggplot(iris, aes(Species, Petal.Length, fill = Species)) + 
  geom_boxplot() + 
  labs(x = "Gatunek", 
       y = "Dugo patka",
       fill='Gatunek') +
  theme_minimal()

p9 <- ggplot(iris, aes(Species, Petal.Width, fill = Species)) + 
  geom_boxplot() + 
  labs(x = "Gatunek", 
       y = "Szeroko patka",
       fill='Gatunek') +
  theme_minimal()
```

Dla wywietlenia czterech obiekt贸w (**p2** i **p3** w g贸rnym wierszu oraz **p4** i **p5** w dolnym wierszu nale偶y wykon poni偶sz komend, a jej rezultat przedstawia @fig-iris5.

```{r}
#| warning: false
#| echo: true
#| eval: true
#| label: fig-iris5
#| fig-cap: Kompozycja 4 wykres贸w. Dugo i szeroko patka wedug gatunku
(p2+p3)/(p4+p5)
```

W obszarze wykresu mo偶na doda tytu i podtytu wykorzystujc `plot_annotation()`. Wynik poni偶szego kodu przedstawia @fig-usun1.

```{r}
#| warning: false
#| echo: true
#| eval: true
#| label: fig-usun1
#| fig-cap: Kompozycja wykres贸w z tytuem i podtytuem. Dugo i szeroko patka wedug gatunku
(p1+p2) / (p3 + p4) + plot_annotation(
  title = "Dugo i szeroko patka wedug gatunk贸w",
  subtitle = "Rozkad cech patk贸w w podziale na gatunki"
)
```

Wykresy nie musz by umieszczane w kratkach o takim samym rozmiarze. Poni偶szy kod przedstawia kostrukcj, gdzie w pierwszel linii jest jeden du偶y wykres, a w drugiej linii dwa mniejsze (@fig-usun3).

```{r}
#| warning: false
#| echo: true
#| eval: true
#| label: fig-usun3
#| fig-cap: Kompozycja wykres贸w z zadan wysokoci obszar贸w. Dugo i szeroko patka wedug gatunku
p5/(p6+p7) + plot_layout(heights = c(2, 1)) +
  plot_annotation(
    title = "Dugo i szeroko patk贸w kwiatu iris",
    subtitle = "Por贸wnanie dugoci i szerokoci patk贸w dla gatunk贸w"
  )
```

Interesujce mo偶e by przedstawienie wielu wykres贸w jednoczenie. Poni偶ej przedstawiono modyfikacj wykres贸w **p1** - **p9**, aby p贸藕niej wszystkie te wykresy umieci w jednym obszrze wykresu.

```{r}
p1 <- p1 + theme(legend.position='bottom')
p2 <- p2 + theme(legend.position='none')
p3 <- p3 + theme(legend.position='none')+labs(title="")
p4 <- p4 + theme(legend.position='none')+labs(title="")
p5 <- p5 + theme(legend.position='none')+labs(title="")
p6 <- p6 + theme(legend.position='none')+labs(title="")
p7 <- p7 + theme(legend.position='none')+labs(title="")
p8 <- p8 + theme(legend.position='none')+labs(title="")
p9 <- p9 + theme(legend.position='none')+labs(title="")
```

Ponizej przedstawiono kod z konstrukcj 7 wykres贸w (@fig-7wyk) rozmieszczonych w 4 wierszach.

```{r}
#| warning: false
#| echo: true
#| eval: true
#| fig-width: 12
#| fig-height: 12
#| fig-cap: Kompozycja 7 wykres贸w. Dugo i szerko patka wedug gatunku
#| label: fig-7wyk
p <- (p2 + p3) /(p4+p5) / (p6+p7) / p1 + plot_layout(heights = c(1, 1,1, 2)) +
  plot_annotation(
    title = "Dugo i szeroko patk贸w kwiatu iris",
    subtitle = "Por贸wnanie dugoci i szerokoci patk贸w dla gatunk贸w"
  )
p
```

Ponizej przedstawiono kod konstrukcji prezentacji z 9 wykresami (@fig-9wyk). W takim przypadku niezbdna jest du偶a powierzchnia dla dobrej czytelnoci przekazu.

```{r}
#| fig-width: 16
#| fig-height: 16
#| fig-cap: Kompozycja 9 wykres贸w. Dugo i szerko patka wedug gatunku
#| label: fig-9wyk
(p4+p2+p5)/(p6+p3+p7)/(p8+p1+p9)
```

Rysunek mo偶na konstruowa stopniowo. W poni偶szym przykadzie w pierwszej kolejnoci zbudowano obiekt **rys**, a nastpnie wywietlono go po lewej stronie okna wykresu (por. @fig-rys1).

```{r }
#| fig-cap: Konstrukja kompozycji wykres贸w. Dugo i szeroko patka wedug gatunku
#| label: fig-rys1
rys <- p2 / p3
 rys|p1
```

Przy rozmieszczaniu wykres贸w mo偶liwe jest pozostawienie wolnego (pustego) obszaru pomidzy nimi. Mo偶na w tym celu wykorzysta funkcj `plot_spacer()`. Poni偶szy kod przedstawia przykad pozostawienia wolnego obszaru w drugim wierszu po lewej stronie (@fig-rys2).

```{r }
#| fig-cap: Zastosowanie funkcji plot_spacer(). Dugo i szeroko patka wedug gatunku
#| label: fig-rys2
p1 +  p2 + plot_spacer() +p3 
```

Podobn konstrukcj przedstawia te偶 kolejny przykad (por. @fig-spacer).

```{r }
#| fig-cap: Pole z wolnym obszarem w kompozycji wykres贸w. Dugo i szeroko patka wedug gatunku
#| label: fig-spacer
p8 +  p1 / plot_spacer() +p9 
```

Wprowadzenie wolnych obszar贸w pomidzy wykresami (`plot_spacer()`)

```{r }
#| fig-cap: Wprowadzenie wolnych obszar贸w w polu ryzunku. Dugo i szeroko patka wedug gatunku
#| label: fig-spacer2
p6 + plot_spacer() + p7 + plot_spacer() + p1 + plot_spacer()
```

Wskazujc kolejne wykresy do kompozycji mo偶liwe jest zadanie liczby kolumn, w kt贸rych bd one wywietlone. Jest to realizowane poprzez odwoanie sie do funkcji `plot_layout()`.

```{r }
#| fig-cap: Ustalenie liczby kolum kompozycji. Dugo i szeroko patka wedug gatunku
#| label: fig-spacer3
p6 + plot_spacer() +p7 + p2 +p1 +  p3 + 
  plot_layout(ncol = 3)
```

Funkcja `plot_layout()` pozwala tak偶e na okrelenie szerokoscvi lub wysokoci poszczeg贸lnych p贸l wykresu. Przykad z ustaleniem dwukrotnie wikszej szerokoci rodkowego pola przedstawia ponizszy kod, kt贸rego rezultat jest na @fig-lay.

```{r}
#| fig-cap: Deklaracja szerokoci obszar贸w. Dugo i szeroko patka wedug gatunku
#| label: fig-lay
(p6/p2) | p1 | (p7/p3)+
    plot_layout(widths = c(1,2, 1))
```

## Ukad wykres贸w wedug wzorca u偶ytkownika

Pakiet **patchwork** umo偶liwia deklarowanie ukadu u偶ytkownika, zgodnie z kt贸rym nastpnie bd rozmieszcane kolejne wykresy. W pierwszym kroku nale偶y okreli odpowiedni wzorzec, jak np.:

```{r }
layout <- '
A#B
#C#
D#E'
```

W powy偶ej wskazanym wzorcu litery oznaczaj pola, kt贸rym zostan przypisane odpowiednie wykresy, a znak "\#" wolne obszary (puste pola) pomidzy wykresami. Przykad konstrukcji kompozycji w oparciu o okrelony powy偶ej wzorzec realizuje poni偶szy kod, kt贸rego wynik przedstawia @fig-wrap.

```{r }
#| fig-cap: Kompozycja ukadu wykres贸w z wykorzystaniem wzorca ukadu. Dugo i szeroko patka wedug gatunku
#| label: fig-wrap
wrap_plots(D = p2, C = p1, B = p5, A=p4,E=p3,design = layout)
```

Konstrujc kompozycje wykres贸w mo偶liwe jest umieszczanie wykres贸w w obszarze innego wykresu. Odpowiedni mo偶liwo przedstawia poni偶szy kod, a rezultat prezentuje @fig-inset.

```{r }
#| fig-cap: Wprowadzenie wykres贸w w obszar pola innego wykresu. Dugo i szeroko patka wedug gatunku
#| label: fig-inset
p1 + 
  inset_element(p2, left = 0.0, bottom = 0.5, right = 0.4, top = 1)+
  inset_element(p3, left = 0.6, bottom = 0.0, right = 1, top = 0.50)
```

## Wprowadzenie do kompozycji tekstu, tabeli lub klasycznego wykresu

Pakiet **patchwork** jako elementy skadowe kompozycji dopuszcza tak偶e wprowadzenie tekstu (np. opis) oraz tradycyjnych wykres贸w. Przykad wprowadzenia tekstu do okna rysunku przedstawia poni偶szy kod, kt贸rego rezultat jest przedstawiony na @fig-grob

```{r }
#| fig-cap: Wprowadzenie tekstu w obszarze wykresu. Dugo i szeroko patka wedug gatunku wraz z opisem
#| label: fig-grob
p1 + grid::textGrob('Na wykresie przedstawiono  \n dugo i szeroko patka kwiatu iris. \n Kolorem wyr贸偶niono \n trzy gatunki.')
```

W obszarze okna wykresu mo偶liwe jest tak偶e umieszczenie tabel. Przykad taki pokazuje poni偶szy kod, kt贸rego rezultat przedstawia @fig-tabela. Na tym rysunku po lewej stronie przedstawiono tabel z wybranymi wierszami zbioru **iris**, a po prawej stronie wykres rozrzutu dla zmiennych dugo pataka i szeroko patka, a poni偶ej tego wykresu jest histogram dugoci patka.

```{r}
#| fig-cap: Kompozycja tabeli i wykres贸w. Tabela z danymi i dwa wykresy
#| label: fig-tabela
#| fig-width: 10
#| fig-height: 10
tbl <- tableGrob(iris[c(1:8, 51:58, 101:108), 3:5])
wrap_elements(tbl) + ((p1+theme(legend.position='none'))/p2+theme(legend.position='bottom'))+
  plot_layout(ncol = 2) 
```

W tym rozdziale wszystkie wykresy byy konstruowane z wykorzystaniem pakietu **ggplot** z wykorzystaniem **patchwork**. Mo偶liwe jest doczenie do konstruowanych kompozycji tradycyjnych wykres贸w wykonanych np. z wykorzystaniem funkcji `plot()`. Dodanie takiego wykresu do kompozycji prezentuje poni偶szy kod, a rezultat przedstawia @fig-plot.

```{r }
#| fig-cap: Kompozycja wykresu z ggplot oraz z funkcji plot. Dugo i szeroko patka wedug gatunku
#| label: fig-plot
p5 + ~plot(iris$Petal.Length, iris$Petal.Width, col=iris[,5],main = 'Wykres 2')
```

::: callout-caution
## wiczenia do samodzielnego wykonania

1.  Skonstruuj wykres punktowy i supkowy dla zbioru **mtcars**, a nastpnie umie je w jednym wierszu.

2.  Skonstruuj ukad 22 z czterech wykres贸w dla zbioru **mtcars**, a nastpnie umie je w jednym wierszu.

3.  Dodaj wsp贸lny tytu do caego ukadu wykres贸w.

4.  Dodaj to lub motyw wsp贸lny dla wszystkich wykres贸w.

5.  U贸偶 dwa wykresy obok siebie, ale pierwszy ma by 2 szerszy ni偶 drugi.
:::
