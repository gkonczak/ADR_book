# Podstawy animacji. Pakiety **gapminder** i **gganimate**


::: {.callout-note icon="false" appearance="simple"}
rodowisko **R** poza zaawansowanymi prezentacjami graficznymi umo偶liwia tak偶e konstrukcj animacji. 
Najpopularniejszym i najczciej u偶ywanym pakietem do tworzenia dynamicznych wizualizacji opartych na pakiecie **ggplot2** jest **gganimate**. Pozwala on w prosty spos贸b doda "*wymiar ruchu*" do statycznych wykres贸w, pokazujc np. zmiany w danych w czasie, ewolucj rozkadu czy wyniki symulacji w kolejnych krokach.
Utworzone animacje nie bd mogy by przedstawione w dokumentach statycznych (\*.pdf, ....), ale mog by z powodzeniem wykorzystywane np. na stronach internetowych (\*.html), w prezentacjach revealjs a nawet w dokumentach \*.docx.

:::


Na wstpie niezbdne jest zaadowanie wykorzystywanych w tym rozdziale pakiet贸w.
Realizuj to kolejne komendy.

```{r}
#| eval: true
#| echo: true
#| warning: false
#| message: false
#| results: hide
library(ggplot2)
library(dplyr)
library(gapminder)
```

## Charakterystyka pakietu i zbioru **gapminder**

::: callout-tip
## **gapminder**

Pakiet **gapminder** w programie **R** zawiera dane u偶ywane przez Hansa Roslinga, szwedzkiego statystyka i popularyzatora wizualizacji danych, w jego synnych prezentacjach o rozwoju wiata.
Zbi贸r danych o nazwie **gapminder** jest g贸wnym elementem pakietu. Dodatkowo s tam zawarte kody pastw i odpowiednio przygotowane palety kolorystyczne.


:::

W tej czci wykorzystywany bdzie zbi贸r danych **gapminder**, kt贸ry jest dostpny po zaadowaniu pakietu o takiej samej nazwie: **gapminder**.


 [Opis zbioru `gapminder`](https://vincentarelbundock.github.io/Rdatasets/doc/causaldata/gapminder.html)

::: callout-important
## **gapminder**

Zbi贸r **gapminder** to ramka danych (data.frame). 
Zbi贸r liczy 1704 obserwacje i 6 zmiennych.

W zbiorze sa nastpujce zmienne:

- *country* (kraj, 142 poziomy)
- *continent* (kontynent, na kt贸rym poo偶ony jest dany kraj, 5 poziom贸w)
- *year* (rok, dla klt贸rego pobrano dane. Zakres lat od 1952 do 2007 co 5 lat)
- *lifeExp* (przecitna dugo 偶ycia w momencie urodzin)
- *pop* (populacja kraju)
- *gdpPercap* (PKB na osob wyra偶ony w USD)

:::


Komenda `summary` pozwala na uzyskanie podstawowych informacji o zbiorze **gapminder**.


```{r }
summary(gapminder)
```

Otrzymane wyniki wskazuj, 偶e dla poszczeg贸lnych pastw dostpne s informacje o *pop, lifeExp i gdpPercap* dla dwunastu lat: 1952, 1957, ..., 2007.
Dodatkowe informacje mo偶na uzyska wykorzystujc funkcj `table`.

```{r }
table(gapminder$continent, gapminder$year)
```

Z powy偶szych danych wynika, 偶e w zbiorze uwzgldniono 30 pastw z Europy. Biorc pod uwag, 偶e dla ka偶dego pastwa jest 12 obserwacji (poszczeg贸lne lata), to cznie dla pastw europejskich jest 360 obserwacji w zbiorze **gapminder**.

## Wybrane wykresy dla danych ze zbioru **gapminder**

Przed przystpieniem do konstrukcji animacji wykonanych zostanie kilka wykres贸w, kt贸re pozwol na lepsze poznanie zbioru **gapminder**.
Zgodnie z informacjami z poprzedniego rozdziau konstrukcja wykresu supkowego przedstawiajcego liczb obserwacji dla poszczeg贸lnych kontynent贸w mo偶e przebiega nastpujco:

```{r }
#| echo: true
#| warning: false
#| label: fig-liczba1
#| fig-cap: Liczba obserwacji wedug kontynent贸w
ggplot(gapminder, aes(x=continent)) + 
  geom_bar()
```

Na @fig-liczba1 przedstawiono liczb obserwacji wedug kontynent贸w w zbiorze **gapminder**.
Taki sam wykres, ale z dodatkowym wyr贸偶nieniem kolorem poszczeg贸lnych kontynent贸w realizuje poni偶szy kod, a efekt jest widoczny na @fig-liczba2.

```{r }
#| echo: true
#| warning: false
#| label: fig-liczba2
#| fig-cap: Liczba obserwacji wedug kontynent贸w - rozr贸偶nienie kolorem kontynent贸w
ggplot(gapminder, aes(x=continent, fill=continent)) + 
  geom_bar() +
  guides(fill='none')
```


Wykres poprzedni (@fig-liczba2) mo偶na zapamita w obiekcie o nazwie **rys** jak w poni偶szym kodzie:

```{r }
#| echo: true
#| warning: false
#| label: fig-liczba3
#| fig-cap: Liczba obserwacji wedug kontynent贸w
rys=ggplot(gapminder, aes(x=continent, fill=continent)) + 
  geom_bar()+
  guides(fill='none')
```

Zapamitanie wykresu w formie obiektu pozwala na wygodne modyfikacje, tak jak w kolejnych dw贸ch przykadach:


- wykres supkowy w orientacji poziomej (@fig-liczba4)

```{r }
#| echo: true
#| warning: false
#| label: fig-liczba4
#| fig-cap: Liczba obserwacji wedug kontynent贸w - ukad poziomy
rys +
  coord_flip()
```

- przedstawienie wykresu we wsp贸rzdnych biegunowych (@fig-liczba5)

```{r }
#| echo: true
#| warning: false
#| label: fig-liczba5
#| fig-cap: Liczba obserwacji wedug kontynent贸w - wsp贸rzdne biegunowe
rys + 
  coord_polar()
```


Nieznaczna modyfikkacja kodu pozwala uzyska typowy wykres koowy (por. @fig-liczba6):


```{r}
#| echo: true
#| warning: false
#| label: fig-liczba6
#| fig-cap: Struktura liczby obserwacji wedug kontynent贸w
dane = as.data.frame(table(gapminder$continent))
colnames(dane) = c("continent", "n")  

ggplot(dane, aes(x = "", y = n, fill = continent)) +
     geom_bar(stat = "identity", width = 1) +
     coord_polar(theta = "y") +
     theme_void() +
     geom_text(aes(label = continent), position = position_stack(vjust = 0.5)) +
     guides(fill = "none")  
```



Rozkad przecitnej dugoci 偶ycia w 2007 roku przedstawi mo偶na z wykorzystaniem histogramu. Odpowiedni kod i wynik jego realizacji przedstawiono na @fig-hist

```{r }
#| echo: true
#| warning: false
#| label: fig-hist
#| fig-cap: Przecitna dugo 偶ycia w pastwach w roku 2007
gapminder %>%
  filter(year==2007) %>%
  ggplot( aes(lifeExp)) + 
  geom_histogram( binwidth=4, color="black", fill="lightblue", alpha=0.5)+
  labs(x="Oczekiwana dugo 偶ycia", y="Liczba pastw")
```

Dla wygodniejszej oceny rozkadu czasu przecitnego trwania 偶ycia w roku 2007 mo偶na do histogramu doda lini gstoci (por @fig-hist2)

```{r }
#| echo: true
#| warning: false
#| label: fig-hist2
#| fig-cap: Przecitna dugo 偶ycia w pastwach w roku 2007 wraz z krzyw teoretyczn
gapminder %>%
  filter(year==2007) %>%
  ggplot( aes(lifeExp)) + 
  geom_histogram(aes(y=after_stat(density)), binwidth=2, color="black", fill="lightblue", alpha=0.5)+
  geom_density()+
  labs(x="oczekiwana dugo 偶ycia", y="Liczba pastw")
```


Dane w zbiorze **gapminder** zawieraj informacje o przecitnej dugoci 偶ycia w r贸偶nych latach.
Dla przedstawienia zmian przecitnej dugoci 偶ycia w latach 1952 - 2007 w wybranych pastwach mo偶na wykorzysta wykres liniowy. Dla wybranych pastw Polska, Niemcy, Czechy, Austria i Rumunia odpowiedni wykres przedstawia @fig-liniowy uzyskany jako realizacja poni偶szego kodu:


```{r }
#| echo: true
#| warning: false
#| label: fig-liniowy
#| fig-cap: Przecitna dugo 偶ycia w wybranych pastwach w latach 1952 - 2007

kraje <- c("Poland", "Germany", "Czech Republic", "Austria","Romania")
ggplot(subset(gapminder, country %in% kraje), aes(x = year, y = lifeExp, color = country)) + 
  geom_line() + 
  geom_point()+
  labs(x="Rok", y="Oczekiwana dugo 偶ycia",color="")+
	theme(legend.position='bottom')	####
```
@fig-liniowy pozwala dostrzec nieustanne zwikszanie si przecitnego trwania 偶ycia w badanym okresie we wszystkich analizowanych pastwach.


Interesujce mo偶e by przedstawienie gstoci czasu trwania 偶ycia wedug kontynent贸w. Realizuje to poni偶szy kod.



```{r }
#| echo: true
#| warning: false
#| label: fig-gest
#| fig-cap: Przecitna dugo 偶ycia wedug kontynent贸w
gapminder %>%
  filter(year==2007) %>%
  ggplot( aes(x=lifeExp, fill=continent)) +
  geom_density(alpha=0.3) +
  labs(x="Rok", y="oczekiwana dugo 偶ycia",fill="Kontynent")
```

Na @fig-gest przedstawiono oceny gstoci rozkadu przecitnego czasu trwania 偶ycia w roku 2007 wedug kontynent贸w. Zauwa偶alne jest, 偶e najkr贸cej si 偶yje w Afryce, a najdu偶ej W Oceani (tylko dwa pastwa Australia i Nowa Zelandia) oraz w Europie.

Ze wzgldu na uproszczenie kolejnych zapis贸w kodu wygodnie bdzie utworzy obiekt `rys1` zgodnie z nastpujcym kodem:

```{r }
rys1 <- gapminder %>%
  filter(year==2007) %>%
  ggplot(aes(continent, lifeExp, fill=continent)) +
  labs(x="", y="Oczekiwana dugo 偶ycia") +
  theme(legend.position='none')
```

W kolejnych przykadach obiekt `rys1` zostanie przedstawiony z wykorzystaniem r贸偶nych reprezentacji geometrycznych.
Pierwsza z takich reprezentacji to `geom_boxplot()` zostaa przedstawiona na @fig-boxplot


```{r }
#| echo: true
#| warning: false
#| label: fig-boxplot
#| fig-cap: Przecitna dugo 偶ycia wedug kontynent贸w - reprezentacja geom_boxplot()
rys1 +
    geom_boxplot(outlier.size=2)
```

Podobn reprezentacj do `geom_boxplot()` jest reprezentacja `geom_violin()`. Odpowiedni wykres przedstawia @fig-violin

Wywietlenie obiektu `rys1` z reprezentacj geometryczn `violin`

```{r }
#| echo: true
#| warning: false
#| label: fig-violin
#| fig-cap: Przecitna dugo 偶ycia wedug kontynent贸w - reprezentacja geom_violin()
rys1 +
  geom_violin()
```

Podobna jak poprzednio konstrukcja obiektu graficznego `rys2`.
Na tym wykresie zamieszczono dane z wszystkich 12 okres贸w czasowych.


```{r }
rys2 <- gapminder %>%
  ggplot(aes(x=gdpPercap, y=lifeExp))+
  labs(x='PKB na osob', y='Oczekiwana dugo 偶ycia')
```

Wywietlenie obiektu `rys2` z reprezentacj geometryczn `geom_point()`.

UWAGA: na wykresie zamieszczono jednoczenie dane z r贸偶nych lat

```{r }
#| echo: true
#| warning: false
#| label: fig-point
#| fig-cap: Produkt krajowy brutto na osob i przecitna dugo 偶ycia 
rys2 + 
  geom_point()
```

W kolejnym kroku do obiektu **rys2** z reprezentacj geometryczn `geom_point()` dodano kolory wedug kontynent贸w. Wykres przedstawiono na @fig-point_col

```{r }
#| echo: true
#| warning: false
#| label: fig-point_col
#| fig-cap: Produkt krajowy brutto na osob i przecitna dugo 偶ycia wedug kontynent贸w
rys2 + 
  geom_point(aes(color=continent))
```

W kolejnym kroku wywietlono obiekt **rys2** z reprezentacj graficzn `geom_point()`, kolorami dla kontynent贸w w oddzielnych oknach. Odpowiedni wykres jest przedstawiony na @fig-point_panel

```{r }
#| echo: true
#| warning: false
#| label: fig-point_panel
#| fig-cap: Produkt krajowy brutto na osob i przecitna dugo 偶ycia wedug kontynent贸w
rys2+
  geom_point(aes(color=continent)) + 
  facet_wrap(.~continent)+
  theme(legend.position='none')
```

Na @fig-point_panel przedstawione punkty reprezentuj pastwa, ale dla jednego kraju jest to a偶 12 punkt贸w (lata 1952, 1957, ..., 2007). Przy konstrukcji aniomacji w kolejnych etpach bd widoczne punkty odpowiadajce okrelonemu ustalonym okresom czasowym.


## Animacje w ggplot2 - pakiet **gganimation**

Program **R** po zainstalowaniu odpowiednich pakiet贸w umo偶liwia przygotowanie r贸偶norodnych animacji.
Jednym z takich pakiet贸w jest **gganimation**.

::: callout-tip
## **gganimate**

Program **R** poza zaawansowan wizualizacj danych umo偶liwia r贸wnie偶 konstrukcj dynamicznych animacji. W tym rozdziale zostan przedstawione podstawowe mo偶liwosci animacji z wykorzystaniem pakietu **gganimate**.
Animacje takie mog zosta zamieszczone na stronach internetowych, osadzone w prezentacjach a tak偶e w plikach formatu docx.
:::


### Zaadowanie bibliotek dla animacji

```{r}
#| eval: true
#| echo: true
#| warning: false
#| message: false
#| results: hide

library(gganimate)
library(gifski)
```

Dla przygotowania animacji w pierwszej kolejnoci zostanie przygotowany i nastpnie wywietlony obiekt **p1**.

```{r }
library(scales)
p1 <- ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, colour = country)) +
  geom_point(alpha = 0.7) +
  scale_x_log10(labels = label_comma()) +  
  theme_minimal() + 
  theme(legend.position = 'none') +
  labs(title = 'Rok: {frame_time}', x = 'PKB na osob', y = 'Oczekiwana dugo 偶ycia') +
  transition_time(year)
p1
```

Utworzenie i wywietlenie obiektu **p2**.

```{r }
#| fig-width: 16
#| fig-height:  8

p2 <- ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, colour = country)) +
  geom_point(alpha = 0.7) +
  scale_x_log10(labels = label_comma()) +  
  theme_minimal() +  
  theme(legend.position = 'none') +
  facet_wrap(~continent,nrow=1) +
  labs(title = 'Rok: {frame_time}', x = 'PKB na osob', y = 'Oczekiwana dugo 偶ycia') +
  transition_time(year)
p2
```


Utworzone zostay dwa obiekty **p1** i **p2**. Obiekty te mo偶na animowa za pomoca funkcji `animate()`.


```{r }
animate(p1, 100, 10)
```

Dodatkowo mo偶na uruchomi animacj z zadanymi wartociami dla wybranych parametr贸w.

```{r }
animate(p1, nframes=100, fps=10,height = 20, width = 30, units = "cm",res=150)
```

Przygotowujc animacj mo偶liwe jest okrelenie wartoci r贸偶nych parametr贸w. Odpowiedni przykad prezentuje kod:


```{r }
p3 <- ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, colour = country)) +
  geom_point(alpha = 0.7) +
  theme(legend.position = 'none') +
  facet_wrap(~continent) +
  labs(title = 'Rok: {frame_time}', x = 'PKB na osob', y = 'Oczekiwana dugo 偶ycia') +
  transition_time(year)+
  scale_colour_manual(values = country_colors) +
  scale_size(range = c(2, 12)) +
  scale_x_log10(labels = label_comma()) +  
  theme_minimal() +  
  facet_wrap(~continent) +
  theme(legend.position = 'none') +
  labs(title = 'Year: {frame_time}', x = 'PKB na osob', y = 'Oczekiwana dugo 偶ycia') +
  transition_time(year) +
  ease_aes('linear')
p3
```

Utworzone animacje mog zosta zapisane np. w plikach formatu \*.gif. Takie rozwizanie pozwala na p贸藕niejsze umieszczenie takiego pliku np. na stronie internetowej. Zapisanie animacji w pliku \*.gif i wywietlenie w zewntrznym oknie realizuje poni偶szy kod:

```{r}
#| eval: true
#| echo: true
#| warning: false
#| message: false
#| results: hide
animacja <- function(){
  datalist <- split(gapminder, gapminder$year)
  lapply(datalist, function(data){
    p4 <- ggplot(data, aes(gdpPercap, lifeExp, size = pop, color = continent)) +
      scale_size("", limits = range(gapminder$pop)) + 
      geom_point() + ylim(20, 90) +
    #  scale_x_log10(limits = range(gapminder$gdpPercap)) + 
      scale_x_log10(labels = label_comma(), limits = range(gapminder$gdpPercap)) +  
      labs(x='PKB na osob', y='Oczekiwana dugo 偶ycia',  color='')+
      ggtitle(data$year) + 
      theme_minimal()+
      theme(legend.position='bottom')
    print(p4)
  })
}
gif_file <- file.path(tempdir(), 'gapminder.gif')
save_gif(animacja(), gif_file, 1280, 720, res = 144)
utils::browseURL(gif_file)
```


::: callout-caution
## wiczenia do samodzielnego wykonania

1. Sprawd藕, jakie s rednie wartoci *gdpPercap* (PKB na osob) i *lifeExp* (oczekiwana dugo 偶ycia) w r贸偶nych krajach w danym roku (np. 2007)

2. Utw贸rz wykres punktowy, na kt贸rym o OX przedstawia *gdpPercap* (PKB na osob), a o OY przedstawia *lifeExp* (oczekiwan dugo 偶ycia). Kolor punkt贸w niech zale偶y od kontynentu (*continent*), a rozmiar punktu od populacji kraju.

3. Oblicz redni warto *gdpPercap* i *lifeExp* dla ka偶dego kontynentu w 2007 roku.


4. Stw贸rz animacj, w kt贸rej o OX przedstawia *gdpPercap*, a o OY *lifeExp*. Ka偶dy punkt to kraj, kt贸ry zmienia swoj pozycj w zale偶noci od roku, a kolor punkt贸w zale偶y od kontynentu.


5. Utw贸rz wykres linii, na kt贸rym por贸wnasz zmiany redniej dugoci 偶ycia w czasie (*lifeExp*) na r贸偶nych kontynentach.

6.  Utw贸rz animacj, kt贸ra pokazuje, jak zmienia si populacja (*pop*) w r贸偶nych krajach w czasie. Wartoci *gdpPercap* (PKB na osob) i *lifeExp* (oczekiwana dugo 偶ycia) bd zmieniay si w zale偶noci od roku, a wielko punktu bdzie zale偶aa od populacji.

:::

